name: "xsd_pattern_preservation_russian_doll"
category: "formats/xsd/patterns"
description: "Test pattern preservation: Russian Doll -> USDL -> XSD preserves Russian Doll pattern"
tags: ['xsd', 'patterns', 'round-trip', 'preservation']

input:
  format: json
  data: |
    {
      "xsdSchema": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\n  <xs:element name=\"order\">\n    <xs:complexType>\n      <xs:sequence>\n        <xs:element name=\"orderId\" type=\"xs:string\"/>\n        <xs:element name=\"customer\">\n          <xs:complexType>\n            <xs:sequence>\n              <xs:element name=\"name\" type=\"xs:string\"/>\n            </xs:sequence>\n          </xs:complexType>\n        </xs:element>\n      </xs:sequence>\n    </xs:complexType>\n  </xs:element>\n</xs:schema>"
    }

transformation: |
  %utlx 1.0
  input json
  output json
  ---
  let inputSchema = $input.xsdSchema
  let usdlSchema = parseXSDSchema(inputSchema)
  let backToXsd = renderXSDSchema(usdlSchema)
  {
    comment: "Russian Doll pattern is now preserved through USDL with synthetic type names",
    inputPattern: "Russian Doll (inline/anonymous types)",
    usdlHasTypes: hasKey(usdlSchema, "%types"),
    usdlTypesEmpty: count(keys(usdlSchema["%types"])) == 0,
    usdlHasInlineTypes: count(keys(usdlSchema["%types"])) > 0,
    outputPattern: "Russian Doll (preserved)",
    outputIsEmpty: contains(backToXsd, "elementFormDefault=\"qualified\"/>"),
    outputHasInlineElements: contains(backToXsd, "<xs:element name=\"order\">") && contains(backToXsd, "<xs:complexType>"),
    capability: "USDL now supports inline types via synthetic names and metadata"
  }

expected:
  format: json
  data: |
    {
      "comment": "Russian Doll pattern is now preserved through USDL with synthetic type names",
      "inputPattern": "Russian Doll (inline/anonymous types)",
      "usdlHasTypes": true,
      "usdlTypesEmpty": false,
      "usdlHasInlineTypes": true,
      "outputPattern": "Russian Doll (preserved)",
      "outputIsEmpty": false,
      "outputHasInlineElements": true,
      "capability": "USDL now supports inline types via synthetic names and metadata"
    }
