name: "multi_input_json_xml_to_xml"
category: "multi-input"
description: "JSON and XML inputs merged to XML output - Modern API with legacy system integration"
tags: ["multi-input", "json", "xml", "integration", "legacy"]

inputs:
  users:
    format: json
    data: |
      {
        "users": [
          {
            "userId": "U001",
            "email": "alice.mueller@example.de",
            "firstName": "Alice",
            "lastName": "Müller",
            "status": "active",
            "registeredDate": "2024-01-15"
          },
          {
            "userId": "U002",
            "email": "bob.schneider@example.de",
            "firstName": "Bob",
            "lastName": "Schneider",
            "status": "active",
            "registeredDate": "2024-03-22"
          },
          {
            "userId": "U003",
            "email": "carol.fischer@example.de",
            "firstName": "Carol",
            "lastName": "Fischer",
            "status": "suspended",
            "registeredDate": "2023-11-05"
          }
        ]
      }

  permissions:
    format: xml
    data: |
      <?xml version="1.0" encoding="UTF-8"?>
      <Permissions>
        <UserPermissions userId="U001">
          <Role>Admin</Role>
          <Access level="full">
            <Module>Users</Module>
            <Module>Reports</Module>
            <Module>Settings</Module>
          </Access>
        </UserPermissions>
        <UserPermissions userId="U002">
          <Role>Editor</Role>
          <Access level="standard">
            <Module>Reports</Module>
            <Module>Dashboard</Module>
          </Access>
        </UserPermissions>
        <UserPermissions userId="U003">
          <Role>Viewer</Role>
          <Access level="readonly">
            <Module>Dashboard</Module>
          </Access>
        </UserPermissions>
      </Permissions>

transformation: |
  %utlx 1.0
  input: users json, permissions xml
  output xml {encoding: "UTF-8"}
  ---
  {
    UserDirectory: {
      @exportDate: "2025-10-21",
      @source: "API+Legacy",
      Integration: {
        ModernAPI: "JSON",
        LegacySystem: "XML",
        LegacyEncoding: detectXMLEncoding($permissions)
      },
      Users: $users.users |> map(user => {
        let userId = user.userId;
        let perms = $permissions.Permissions.UserPermissions |> filter(p => p.@userId == userId) |> first();

        User: {
          @id: userId,
          @status: user.status,
          Profile: {
            Email: user.email,
            FullName: user.firstName + " " + user.lastName,
            RegisteredDate: user.registeredDate
          },
          Authorization: {
            Role: perms.Role,
            AccessLevel: perms.Access.@level,
            Modules: (if (isArray(perms.Access.Module)) perms.Access.Module else [perms.Access.Module]) |> map(mod => {
              Module: mod
            })
          }
        }
      })
    }
  }

expected:
  format: xml
  data: |
    <?xml version="1.0" encoding="UTF-8"?>
    <UserDirectory exportDate="2025-10-21" source="API+Legacy">
      <Integration>
        <ModernAPI>JSON</ModernAPI>
        <LegacySystem>XML</LegacySystem>
        <LegacyEncoding>UTF-8</LegacyEncoding>
      </Integration>
      <Users>
        <User id="U001" status="active">
          <Profile>
            <Email>alice.mueller@example.de</Email>
            <FullName>Alice Müller</FullName>
            <RegisteredDate>2024-01-15</RegisteredDate>
          </Profile>
          <Authorization>
            <Role>Admin</Role>
            <AccessLevel>full</AccessLevel>
            <Modules>
              <Module>Users</Module>
              <Module>Reports</Module>
              <Module>Settings</Module>
            </Modules>
          </Authorization>
        </User>
        <User id="U002" status="active">
          <Profile>
            <Email>bob.schneider@example.de</Email>
            <FullName>Bob Schneider</FullName>
            <RegisteredDate>2024-03-22</RegisteredDate>
          </Profile>
          <Authorization>
            <Role>Editor</Role>
            <AccessLevel>standard</AccessLevel>
            <Modules>
              <Module>Reports</Module>
              <Module>Dashboard</Module>
            </Modules>
          </Authorization>
        </User>
        <User id="U003" status="suspended">
          <Profile>
            <Email>carol.fischer@example.de</Email>
            <FullName>Carol Fischer</FullName>
            <RegisteredDate>2023-11-05</RegisteredDate>
          </Profile>
          <Authorization>
            <Role>Viewer</Role>
            <AccessLevel>readonly</AccessLevel>
            <Modules>
              <Module>Dashboard</Module>
            </Modules>
          </Authorization>
        </User>
      </Users>
    </UserDirectory>

performance_limits:
  max_duration_ms: 200
  max_memory_mb: 20

metadata:
  author: "UTL-X Team"
  created_date: "2025-10-21"
  references:
    - "Multiple inputs feature"
    - "JSON to XML transformation"
    - "Legacy system integration"
  notes:
    - "JSON (modern API) + XML (legacy) → XML (unified)"
    - "Common enterprise pattern: merging new and old systems"
    - "German characters preserved (Müller, Schneider, Fischer)"
    - "Array flattening for modules"
