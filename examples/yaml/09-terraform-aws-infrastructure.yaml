# Terraform Configuration in YAML (using terramate or similar)
# AWS Multi-Region Infrastructure
version: "1.0"
terraform:
  required_version: ">= 1.6.0"
  required_providers:
    aws:
      source: hashicorp/aws
      version: "~> 5.0"

variables:
  environment:
    type: string
    description: "Deployment environment"
    default: "production"
    validation:
      condition: "var.environment in ['development', 'staging', 'production']"
  
  project_name:
    type: string
    description: "Project name for resource naming"
    default: "ecommerce-platform"
  
  aws_regions:
    type: list(string)
    description: "AWS regions for multi-region deployment"
    default: ["us-west-2", "us-east-1", "eu-west-1"]
  
  vpc_cidr:
    type: map(string)
    description: "VPC CIDR blocks per region"
    default:
      us-west-2: "10.0.0.0/16"
      us-east-1: "10.1.0.0/16"
      eu-west-1: "10.2.0.0/16"

resources:
  vpc:
    for_each: var.aws_regions
    provider: aws.{{ each.key }}
    type: aws_vpc
    properties:
      cidr_block: "{{ lookup(var.vpc_cidr, each.value) }}"
      enable_dns_hostnames: true
      enable_dns_support: true
      tags:
        Name: "{{ var.project_name }}-{{ var.environment }}-vpc-{{ each.value }}"
        Environment: "{{ var.environment }}"
        Region: "{{ each.value }}"
        ManagedBy: "Terraform"

  eks_cluster:
    for_each: var.aws_regions
    type: aws_eks_cluster
    properties:
      name: "{{ var.project_name }}-{{ var.environment }}-eks-{{ each.value }}"
      role_arn: "{{ aws_iam_role.eks_cluster.arn }}"
      version: "1.28"
      vpc_config:
        subnet_ids: "{{ aws_subnet.private[each.key].*.id }}"
        endpoint_private_access: true
        endpoint_public_access: false
      encryption_config:
        - provider:
            key_arn: "{{ aws_kms_key.eks[each.key].arn }}"
          resources: ["secrets"]
      enabled_cluster_log_types:
        - api
        - audit
        - authenticator
        - controllerManager
        - scheduler

  rds_global_cluster:
    type: aws_rds_global_cluster
    properties:
      global_cluster_identifier: "{{ var.project_name }}-{{ var.environment }}-global"
      database_name: "{{ var.project_name }}"
      engine: aurora-postgresql
      engine_version: "15.3"
      storage_encrypted: true

outputs:
  vpc_ids:
    description: "VPC IDs per region"
    value: "{{ { for k, v in aws_vpc.vpc : k => v.id } }}"
  
  eks_endpoints:
    description: "EKS cluster endpoints"
    value: "{{ { for k, v in aws_eks_cluster.eks_cluster : k => v.endpoint } }}"
